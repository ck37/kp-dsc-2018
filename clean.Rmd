---
title: "Clean raw data"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
 
# Contains custom SuperLearner wrappers and screeners.
source("R/sl-library.R")

# TODO: consolidate these library calls into a separate function so that
# we are consistent across Rmd files.
library(ggplot2)
library(SuperLearner)
library(data.table)
library(xgboost)
library(glmnet)
library(ranger)
library(doParallel)
# Install this version, the CRAN version is very old sadly --
# devtools::install_github("ck37/ck37r")
library(ck37r)
```

```{r import_data}

# Import as a data.frame rather than a data.table - avoids extra complication.
data = data.table::fread("data-raw/train.csv", data.table = FALSE)
dim(data)

names(data) = tolower(names(data))

# Review classes in our dataset.
table(sapply(data, class))
sapply(data, class)

```

```{r data_prep}
# Define our outcome variable.
var_outcome = "label"

# Specify which variables we don't want to use for prediction.
remove_cols = c(var_outcome,
                # Simply notes that this is all training data.
                "kaggleset",
                # TODO: figure out what these columns mean.
                "eventid", "kaggleweight", "weight")

# Create a list to save our outcome, data, and covariates.
# This can then be used for EDA, modeling, etc.
task = list(
  # Save our primary dataset.
  data = data,
  # Specify which covariates we can use for predicting the outcome
  # (these are only the column names, which can be indexed into task$data).
  covariates = names(data)[!names(data) %in% remove_cols],
  # Specify the outcome vector.
  outcome = as.integer(data[[var_outcome]] == "s")
)

# Review covariates.
task$covariates

# Review outcome distribution.
table(task$outcome, useNA = "ifany")
prop.table(table(task$outcome, useNA = "ifany"))
```

## Missing values

```{r missing_values}
# TODO:
# Replace -999 values with NA for all of our covariates.
#data that is missing is coded as -999, needs recoded
table(is.na(data)) 
head(data)
data <- sapply(data, function(col){
  col[col==-999] <- NA
  col
})
table(is.na(data))
head(data)

# Add missingness indicators and impute missing values (e.g. to median).
# See ck37r::impute_missing_values()

# Add missingness indicators to task$covariates
```

## Save results

```{r save_results}

save(task,
     # TODO: also save imputation object for future reference.
     file = "data/clean.RData")
```
