---
title: "Clean raw data"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

# Load an initial pair of startup functions.
source("R/_startup.R")
# Load necessary libraries; set auto_install = TRUE to try to install any needed packages.
startup(auto_install = FALSE, verbose = FALSE)
# Load all .R files in the R/ subdirectory.
ck37r::load_all_code("R", verbose = TRUE)
```

```{r import_data}

# Import as a data.frame rather than a data.table - avoids extra complication.
data = data.table::fread("data-raw/train.csv", data.table = FALSE)
dim(data)

names(data) = tolower(names(data))

# Review classes in our dataset.
table(sapply(data, class))
sapply(data, class)

# Review the number of unique values in each column.
sapply(data, function(col) { length(unique(col)) })

# pri_jet_num has only 4 so let's convert it to a factor.
data$pri_jet_num = factor(data$pri_jet_num)
table(data$pri_jet_num)
```

```{r data_prep}
# Define our outcome variable.
var_outcome = "label"

# Specify which variables we don't want to use for prediction.
remove_cols = c(var_outcome,
                # Simply notes that this is all training data.
                "kaggleset",
                # TODO: figure out what these columns mean.
                "eventid", "kaggleweight", "weight")

# Create a list to save our outcome, data, and covariates.
# This can then be used for EDA, modeling, etc.
task = list(
  # Save our primary dataset.
  data = data,
  # Specify which covariates we can use for predicting the outcome
  # (these are only the column names, which can be indexed into task$data).
  covariates = names(data)[!names(data) %in% remove_cols],
  # Specify the outcome vector.
  outcome = as.integer(data[[var_outcome]] == "s")
)

# Review covariates.
task$covariates

# Review outcome distribution.
table(task$outcome, useNA = "ifany")
prop.table(table(task$outcome, useNA = "ifany"))
```

## Missing values

```{r missing_values}
sapply(data, class)
table(is.na(data)) 
head(data)

colMeans(is.na(data))

# Replace -999 values with NA for all of our covariates.
data[, task$covariates] <- lapply(data[, task$covariates], function(col) {
  col[col == -999] <- NA
  col
})
table(is.na(data))
colMeans(is.na(data[, task$covariates]))
head(data)
class(data)
sapply(data, class)

# Add missingness indicators and impute missing values to median.
impute <- ck37r::impute_missing_values(data, type = "standard", verbose = TRUE)

task$data <- impute$data

# Clear out this $data element so that we don't have two copies of the data.
impute$data = NULL

# Add missingness indicators to task$covariates
task$covariates <- c(task$covariates, "miss_der_mass_mmc", "miss_der_deltaeta_jet_jet", "miss_pri_jet_leading_pt")

```

## Convert factors to indicators

```{r}
# This will only apply to $pri_jet_num
# We need to do the same step on the testing data.
factors = ck37r::factors_to_indicators(data, predictors = task$covariates, verbose = TRUE)
names(factors)
task$data = factors$data
# Clear out this extra copy of the dataframe to save memory & storage size.
factors$data = NULL
# Update our covariate list to include the 3 new indicator columns.
task$covariates = factors$predictors
```

## Save results

```{r save_results}

# Save imputation and factor objects for future reference and use on test dataset.
save(task, impute, factors,
     file = "data/clean.RData")
```
