---
title: "import data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/sl-library.R")

library(SuperLearner)
library(data.table)
library(xgboost)
library(glmnet)
library(ranger)
```

```{r}

data = data.table::fread("data-raw/train.csv")
dim(data)

names(data) = tolower(names(data))

table(sapply(data, class))
sapply(data, class)

# It's all training data - can remove this column.
table(data$kaggleset)
data$kaggleset = NULL

tibble::glimpse(data)

# No missing data - NAs at least.
colMeans(is.na(data))


table(data$label, useNA = "ifany")

data$label = as.factor(data$label)
```

```{r}
x = as.data.frame(data)[, !names(data) %in% c("label")]
y = as.numeric(data$label == "s")
```

# Reg analysis

```{r}
reg = lm(as.numeric(label) ~ ., data = data)

# Adj. R-sqr of 0.6219
summary(reg)
```

# Most basic model possible

```{r sl}

screen.corRank5 = function(...) screen.corRank2(..., rank = 5)

# Add screeners so that it's not as slow to estimate.
sl_lib = list(c("SL.xgboost_fast", "screen.corRank5"),
              c("SL.ranger_fast", "screen.corRank5"),
                "SL.glmnet_fast",
                "SL.mean")

sl = SuperLearner::SuperLearner(Y = y, X = x,
                  family = binomial(),
                  verbose = TRUE,
                  SL.library = sl_lib,
                  cvControl = SuperLearner.CV.control(V = 3L))
sl

ck37r::auc_table(sl, y = y)

ck37r::plot_roc(sl, y = y)

save(sl, file = "data/model-proof-of-concept-sl.RData")
```

# Predict on test

```{r}
test = data.table::fread("data-raw/test.csv")
dim(test)

names(test) = tolower(names(test))

test$kaggleset = NULL

predictions = predict(sl, test, onlySL = TRUE)$pred

summary(predictions)

qplot(predictions)

# TODO: fix $someid.
export = cbind(test$someid, predictions)

rio::export(export, path = "exports/proof-of-concept.csv")

```
